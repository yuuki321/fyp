{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- 侧边栏 -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">{{ _('Admin Panel') }}</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="#" class="list-group-item list-group-item-action active" 
                       data-bs-toggle="tab" data-bs-target="#users">
                        <i class="fas fa-users"></i> {{ _('User Management') }}
                    </a>
                    <a href="#" class="list-group-item list-group-item-action"
                       data-bs-toggle="tab" data-bs-target="#models">
                        <i class="fas fa-brain"></i> {{ _('AI Models') }}
                    </a>
                    <a href="#" class="list-group-item list-group-item-action"
                       data-bs-toggle="tab" data-bs-target="#training">
                        <i class="fas fa-graduation-cap"></i> {{ _('Model Training') }}
                    </a>
                </div>
            </div>
        </div>

        <!-- 主要内容区 -->
        <div class="col-md-9">
            <div class="tab-content">
                <!-- 用户管理 -->
                <div class="tab-pane fade show active" id="users">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">{{ _('User Management') }}</h5>
                            <input type="text" class="form-control form-control-sm w-auto" 
                                   placeholder="{{ _('Search users...') }}" id="userSearch">
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>{{ _('Username') }}</th>
                                            <th>{{ _('Email') }}</th>
                                            <th>{{ _('Role') }}</th>
                                            <th>{{ _('Created') }}</th>
                                            <th>{{ _('Last Login') }}</th>
                                            <th>{{ _('Actions') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for user in users %}
                                        <tr>
                                            <td>{{ user.id }}</td>
                                            <td>{{ user.username }}</td>
                                            <td>{{ user.email }}</td>
                                            <td>
                                                <select class="form-select form-select-sm" 
                                                        onchange="updateUserRole({{ user.id }}, this.value)">
                                                    <option value="user" 
                                                            {% if user.role == 'user' %}selected{% endif %}>
                                                        {{ _('User') }}
                                                    </option>
                                                    <option value="premium" 
                                                            {% if user.role == 'premium' %}selected{% endif %}>
                                                        {{ _('Premium') }}
                                                    </option>
                                                    <option value="admin" 
                                                            {% if user.role == 'admin' %}selected{% endif %}>
                                                        {{ _('Admin') }}
                                                    </option>
                                                </select>
                                            </td>
                                            <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                                            <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login }}</td>
                                            <td>
                                                <button class="btn btn-sm btn-danger" 
                                                        onclick="deleteUser({{ user.id }})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI模型管理 -->
                <div class="tab-pane fade" id="models">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">{{ _('AI Models') }}</h5>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" 
                                    data-bs-target="#addModelModal">
                                <i class="fas fa-plus"></i> {{ _('Add Model') }}
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for model in ai_models %}
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h5 class="card-title">{{ model.name }}</h5>
                                            <p class="card-text">{{ model.description }}</p>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" 
                                                       onchange="toggleModel({{ model.id }})"
                                                       {% if model.active %}checked{% endif %}>
                                                <label class="form-check-label">{{ _('Active') }}</label>
                                            </div>
                                        </div>
                                        <div class="card-footer">
                                            <button class="btn btn-sm btn-info">
                                                <i class="fas fa-edit"></i> {{ _('Edit') }}
                                            </button>
                                            <button class="btn btn-sm btn-danger">
                                                <i class="fas fa-trash"></i> {{ _('Delete') }}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 模型训练 -->
                <div class="tab-pane fade" id="training">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">{{ _('Model Training') }}</h5>
                        </div>
                        <div class="card-body">
                            <form id="trainingForm">
                                <div class="mb-3">
                                    <label class="form-label">{{ _('Select Model') }}</label>
                                    <select class="form-select" name="model_id" required>
                                        {% for model in ai_models %}
                                        <option value="{{ model.id }}">{{ model.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">{{ _('Training Data') }}</label>
                                    <input type="file" class="form-control" name="training_data" 
                                           accept=".mid,.midi,.mp3,.wav" multiple>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">{{ _('Training Parameters') }}</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label">{{ _('Epochs') }}</label>
                                            <input type="number" class="form-control" name="epochs" 
                                                   value="100" min="1">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">{{ _('Batch Size') }}</label>
                                            <input type="number" class="form-control" name="batch_size" 
                                                   value="32" min="1">
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-play"></i> {{ _('Start Training') }}
                                </button>
                            </form>

                            <!-- 训练进度 -->
                            <div class="mt-4">
                                <h6>{{ _('Training Progress') }}</h6>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%"></div>
                                </div>
                                <div id="trainingStatus" class="mt-2">
                                    <small class="text-muted">{{ _('No active training') }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加模型模态框 -->
<div class="modal fade" id="addModelModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Add New Model') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addModelForm">
                    <div class="mb-3">
                        <label class="form-label">{{ _('Model Name') }}</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _('Description') }}</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _('Model Type') }}</label>
                        <select class="form-select" name="type">
                            <option value="generation">{{ _('Music Generation') }}</option>
                            <option value="completion">{{ _('Music Completion') }}</option>
                            <option value="style_transfer">{{ _('Style Transfer') }}</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {{ _('Cancel') }}
                </button>
                <button type="button" class="btn btn-primary" onclick="addModel()">
                    {{ _('Add Model') }}
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// 用户管理功能
function updateUserRole(userId, newRole) {
    fetch(`/admin/user/${userId}/role`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ role: newRole })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showAlert('success', '{{ _("User role updated successfully") }}');
        } else {
            showAlert('danger', data.message);
        }
    });
}

function deleteUser(userId) {
    if (confirm('{{ _("Are you sure you want to delete this user?") }}')) {
        fetch(`/admin/user/${userId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                showAlert('danger', data.message);
            }
        });
    }
}

// 模型管理功能
function addModel() {
    const form = document.getElementById('addModelForm');
    const formData = new FormData(form);

    fetch('/admin/model/add', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        } else {
            showAlert('danger', data.message);
        }
    });
}

function toggleModel(modelId) {
    fetch(`/admin/model/${modelId}/toggle`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showAlert('success', '{{ _("Model status updated") }}');
        } else {
            showAlert('danger', data.message);
        }
    });
}

// 训练功能
document.getElementById('trainingForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch('/admin/model/train', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            startTrainingProgress(data.training_id);
        } else {
            showAlert('danger', data.message);
        }
    });
});

function startTrainingProgress(trainingId) {
    const progressBar = document.querySelector('.progress-bar');
    const statusDiv = document.getElementById('trainingStatus');
    
    function updateProgress() {
        fetch(`/admin/training/${trainingId}/status`)
            .then(response => response.json())
            .then(data => {
                progressBar.style.width = data.progress + '%';
                statusDiv.innerHTML = data.status;
                
                if (data.progress < 100) {
                    setTimeout(updateProgress, 1000);
                }
            });
    }
    
    updateProgress();
}

// 工具函数
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container').insertAdjacentElement('afterbegin', alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}
</script>
{% endblock %} 